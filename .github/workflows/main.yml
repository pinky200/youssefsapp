name: Deployment Pipeline with Manual Approval

on:
  push:
    branches: [main]

jobs:
  # STAGE 1: Build and push images
  build-push:
    runs-on: self-hosted
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_TAG: ${{ github.sha }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: Build and push frontend
        working-directory: ./frontapp
        run: |
          docker build -t $DOCKERHUB_USERNAME/frontapp:$IMAGE_TAG -t $DOCKERHUB_USERNAME/frontapp:latest .
          docker push $DOCKERHUB_USERNAME/frontapp:$IMAGE_TAG
          docker push $DOCKERHUB_USERNAME/frontapp:latest

      - name: Build and push backend
        working-directory: ./backapp
        run: |
          docker build -t $DOCKERHUB_USERNAME/backapp:$IMAGE_TAG -t $DOCKERHUB_USERNAME/backapp:latest .
          docker push $DOCKERHUB_USERNAME/backapp:$IMAGE_TAG
          docker push $DOCKERHUB_USERNAME/backapp:latest

  # STAGE 2: Deploy to Staging (auto)
  deploy-staging:
    runs-on: self-hosted
    needs: build-push
    environment: staging
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_TAG: ${{ github.sha }}
    
    steps:
      - name: Deploy to Staging
        run: |
          helm upgrade --install youssefsapp-staging ./helm/youssefsapp/ \
            -n staging \
            -f ./helm/youssefsapp/values-staging.yaml \
            --set frontend.image.repository=$DOCKERHUB_USERNAME/frontapp \
            --set frontend.image.tag=$IMAGE_TAG \
            --set backend.image.repository=$DOCKERHUB_USERNAME/backapp \
            --set backend.image.tag=$IMAGE_TAG

      - name: Verify Staging Deployment
        run: |
          echo "Staging deployment completed!"
          kubectl get all -n staging

  # STAGE 3: Manual Approval for Production
  request-production-approval:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Wait for Manual Approval
        run: |
          echo "âœ… Staging deployment successful!"
          echo "ðŸ“‹ Waiting for manual approval to deploy to production..."

  # STAGE 4: Deploy to Production (after manual approval)
  deploy-production:
    needs: request-production-approval
    runs-on: self-hosted
    environment: production
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_TAG: ${{ github.sha }}
    
    steps:
      - name: Deploy to Production
        run: |
          helm upgrade --install youssefsapp-prod ./helm/youssefsapp/ \
            -n production \
            -f ./helm/youssefsapp/values-prod.yaml \
            --set frontend.image.repository=$DOCKERHUB_USERNAME/frontapp \
            --set frontend.image.tag=$IMAGE_TAG \
            --set backend.image.repository=$DOCKERHUB_USERNAME/backapp \
            --set backend.image.tag=$IMAGE_TAG

      - name: Verify Production Deployment
        run: |
          echo "ðŸŽ‰ Production deployment completed!"
          kubectl get all -n production
