name: CI/CD with Minikube and Docker Hub

on:
  push:
    branches:
      - main   # 👈 هيشتغل بس لما تعمل push على main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout الكود
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Login في Docker Hub (باستخدام Secrets)
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}   # 👈 حط اليوزر بتاعك في Settings > Secrets
          password: ${{ secrets.DOCKERHUB_TOKEN }}      # 👈 Access Token من Docker Hub

      # 3️⃣ Install Minikube
      - name: Set up Minikube
        uses: medyagh/setup-minikube@latest
        with:
          kubernetes-version: v1.33.1   # 👈 نفس النسخة اللي عندك

      # 4️⃣ Build & Push Docker Image to Docker Hub
      - name: Build & Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp:latest

      # 5️⃣ Install Helm
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # 6️⃣ Deploy باستخدام Helm
      - name: Deploy with Helm
        run: |
          helm upgrade --install youssefsapp ./helm-chart \
            --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp \
            --set image.tag=latest
  helm upgrade --install youssefsapp ./helm-chart \
            --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp \
            --set image.tag=latest
