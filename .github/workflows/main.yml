name: CI/CD with Minikube and Docker Hub

on:
  push:
    branches:
      - main   # ğŸ‘ˆ Ù‡ÙŠØ´ØªØºÙ„ Ø¨Ø³ Ù„Ù…Ø§ ØªØ¹Ù…Ù„ push Ø¹Ù„Ù‰ main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout Ø§Ù„ÙƒÙˆØ¯
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Login ÙÙŠ Docker Hub (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Secrets)
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}   # ğŸ‘ˆ Ø­Ø· Ø§Ù„ÙŠÙˆØ²Ø± Ø¨ØªØ§Ø¹Ùƒ ÙÙŠ Settings > Secrets
          password: ${{ secrets.DOCKERHUB_TOKEN }}      # ğŸ‘ˆ Access Token Ù…Ù† Docker Hub

      # 3ï¸âƒ£ Install Minikube
      - name: Set up Minikube
        uses: medyagh/setup-minikube@latest
        with:
          kubernetes-version: v1.33.1   # ğŸ‘ˆ Ù†ÙØ³ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ

      # 4ï¸âƒ£ Build & Push Docker Image to Docker Hub
      - name: Build & Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp:latest

      # 5ï¸âƒ£ Install Helm
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # 6ï¸âƒ£ Deploy Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Helm
      - name: Deploy with Helm
        run: |
          helm upgrade --install youssefsapp ./helm-chart \
            --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp \
            --set image.tag=latest
  helm upgrade --install youssefsapp ./helm-chart \
            --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/youssefsapp \
            --set image.tag=latest
