name: Deployment Pipeline with Manual Approval

on:
  push:
    branches: [main]

jobs:
  # STAGE 1: Build and push images
  build-push:
    runs-on: self-hosted
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_TAG: ${{ github.sha }}
      FRONT_REPO: ${{ secrets.DOCKER_USERNAME }}/frontapp
      BACK_REPO: ${{ secrets.DOCKER_USERNAME }}/backapp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build frontend image
        working-directory: ./frontapp
        run: |
          docker build -t $FRONT_REPO:${IMAGE_TAG} -t $FRONT_REPO:latest .

      - name: Push frontend image
        run: |
          docker push $FRONT_REPO:${IMAGE_TAG}
          docker push $FRONT_REPO:latest

      - name: Build backend image
        working-directory: ./backapp
        run: |
          docker build -t $BACK_REPO:${IMAGE_TAG} -t $BACK_REPO:latest .

      - name: Push backend image
        run: |
          docker push $BACK_REPO:${IMAGE_TAG}
          docker push $BACK_REPO:latest

  # STAGE 2: Deploy to Staging (auto)
  deploy-staging:
    runs-on: self-hosted
    needs: build-push
    environment: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Staging
        run: |
          helm upgrade --install youssefsapp-staging ./helm/youssefsapp/ \
            -n staging \
            -f ./helm/youssefsapp/values-staging.yaml \
            --set frontend.image.repository=$FRONT_REPO \
            --set frontend.image.tag=${IMAGE_TAG} \
            --set backend.image.repository=$BACK_REPO \
            --set backend.image.tag=${IMAGE_TAG} \
            --set imagePullSecrets[0].name=regcred

      - name: Verify Staging Deployment
        run: |
          echo "Staging deployment completed!"
          kubectl get all -n staging

  # STAGE 3: Manual Approval for Production
  request-production-approval:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Wait for Manual Approval
        run: |
          echo "âœ… Staging deployment successful!"
          echo "ðŸ“‹ Waiting for manual approval to deploy to production..."
          echo "ðŸ‘¤ Please approve the deployment in the GitHub Environments tab"

  # STAGE 4: Deploy to Production (after manual approval)
  deploy-production:
    needs: request-production-approval
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          helm upgrade --install youssefsapp-prod ./helm/youssefsapp/ \
            -n production \
            -f ./helm/youssefsapp/values-prod.yaml \
            --set frontend.image.repository=$FRONT_REPO \
            --set frontend.image.tag=${IMAGE_TAG} \
            --set backend.image.repository=$BACK_REPO \
            --set backend.image.tag=${IMAGE_TAG} \
            --set imagePullSecrets[0].name=regcred

      - name: Verify Production Deployment
        run: |
          echo "ðŸŽ‰ Production deployment completed!"
          kubectl get all -n production
          kubectl get ingress -n productionname: Deployment Pipeline with Manual Approval

