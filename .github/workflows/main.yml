name: CI/CD (Minikube + Docker Hub + Helm) - Self Hosted

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
  FRONT_IMAGE: ${{ secrets.DOCKER_USERNAME }}/frontapp
  BACK_IMAGE:  ${{ secrets.DOCKER_USERNAME }}/backapp
  IMAGE_TAG:   ${{ github.sha }}

jobs:
  build_and_deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build & Push FRONT image
      run: |
        docker build -t "$FRONT_IMAGE:$IMAGE_TAG" -t "$FRONT_IMAGE:latest" ./frontapp
        docker push "$FRONT_IMAGE:$IMAGE_TAG"
        docker push "$FRONT_IMAGE:latest"

    - name: Build & Push BACK image
      run: |
        docker build -t "$BACK_IMAGE:$IMAGE_TAG" -t "$BACK_IMAGE:latest" ./backapp
        docker push "$BACK_IMAGE:$IMAGE_TAG"
        docker push "$BACK_IMAGE:latest"

    - name: Enable Ingress (if not enabled)
      run: |
        minikube status || minikube start
        minikube addons enable ingress
        kubectl -n ingress-nginx rollout status deploy/ingress-nginx-controller --timeout=180s

    - name: Setup Helm
      uses: azure/setup-helm@v4

    - name: Create/Update imagePullSecret
      env:
        DH_USER: ${{ secrets.DOCKER_USERNAME }}
        DH_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        kubectl create secret docker-registry regcred \
          --docker-username="$DH_USER" \
          --docker-password="$DH_PASS" \
          --docker-email="ci@example.com" \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Helm upgrade/install
      run: |
        helm upgrade --install youssefsapp ./helm/youssefsapp \
          --set frontend.image.repository="$FRONT_IMAGE" \
          --set frontend.image.tag="$IMAGE_TAG" \
          --set frontend.image.pullPolicy=Always \
          --set backend.image.repository="$BACK_IMAGE" \
          --set backend.image.tag="$IMAGE_TAG" \
          --set backend.image.pullPolicy=Always

    - name: Wait for rollout & show pods
      run: |
        kubectl rollout status deploy/youssefsapp-front --timeout=180s || true
        kubectl rollout status deploy/youssefsapp-back  --timeout=180s || true
        kubectl get pods -A
